import type { GradingRequest } from '@/types';

export function generateGradingPrompt(request: GradingRequest): string {
  const { questionText, referenceAnswer, studentAnswer, scoringCriteria } = request;

  return `
作为专业的教育评估专家，请对学生答案进行5分制评分并生成学习建议。

⚠️ **第一步：预检查（强制执行，不可跳过）**

在进行详细评分前，必须先判断学生答案是否属于以下类型：

【立即给1分的情况 - 无需进一步分析】：
- 纯数字（如"1111"、"123"、"666"等）
- 无意义字符（如"aaaa"、"测试"、"asdfjkl"等）
- 乱码或特殊符号（如"@#$%"、"？？？"等）
- 完全空白或仅有标点符号
- 明显的应付作答（如"不会"、"不知道"、"随便写写"等）
- 与题目完全无关的内容

如果学生答案属于以上任何一种情况，必须：
1. 立即给出分数：1分
2. scoreLabel：需要加强
3. 在feedback中明确指出这是无效答案
4. 其他字段仍需正常生成（升级答案、鼓励等）

---

**题目：**
${questionText}

**参考答案：**
${referenceAnswer}

${scoringCriteria ? `**评分细则：**\n${scoringCriteria}\n` : ''}
**学生答案：**
${studentAnswer}

---

**第二步：正常评分（仅在通过预检查后执行）**

**评分标准（满分5分）：**
- 5分 优秀：完全正确，论述全面深入，表达清晰流畅
- 4分 良好：基本正确，有一定深度，表达较好
- 3分 中等：部分正确，论述一般，有明显不足
- 2分 及格：有对的内容，但问题较多
- 1分 需要加强：大部分错误或严重偏题

**评分要求（严格遵守）：**
1. **仔细对比学生答案与参考答案**，检查知识点覆盖度、准确性、完整性
2. **答非所问或完全错误**的答案必须给1-2分
3. **仅包含少量正确内容**的答案给2-3分
4. **基本正确但不够完整**的答案给3-4分
5. **完全正确且表述优秀**的答案才给5分

---

**任务要求：**

1. **5分制评分**：给出1-5分的评分和对应等级

2. **生成升级答案模板**（考研应试导向）：
   - 目标分数：当前分数 + 1分
   - 提供一个完整的、可以直接背诵的答案模板
   - 标注关键得分点（3-5个），每个得分点都是考试能拿分的核心要素

3. **详细反馈**（考研应试导向）：
   - 优点：答对的知识点（1个）
     * 指出学生答案中答对的关键知识点
     * 说明"这个点答到了就能拿X分"
   - 待改进：缺失或答错的得分点（至少2个）
     * 指出学生答案中缺失的关键知识点
     * 明确告诉学生"XXX这个点没答到，会丢X分"
     * 对比参考答案，说明哪些关键词/知识点必须要写
   - 学习建议：如何记住知识点（至少3个）
     * 告诉学生如何记忆关键知识点（不是如何理解或研究）
     * 提供记忆技巧（如"记住三个关键词：XXX、XXX、XXX"）
     * 强调考试中必须写出的要点

4. **加油鼓励**：
   - 一句话鼓励（根据实际得分情况给予真实反馈，15字内）
   - 学习小贴士（告诉学生如何提高，包含emoji）

---

**返回JSON格式（严格遵守）：**
{
  "score": 3,
  "scoreLabel": "中等",
  "upgradeAnswer": {
    "targetScore": 4,
    "templateAnswer": "完整的可背诵答案模板，结构清晰，包含所有得分点。第一段总起...",
    "keyPoints": [
      "得分点1：XXX（答到这个点得X分）",
      "得分点2：XXX（答到这个点得X分）",
      "得分点3：XXX（答到这个点得X分）"
    ]
  },
  "feedback": {
    "strengths": [
      "你答出了\"XXX\"这个知识点，这是核心得分点，能拿2分"
    ],
    "weaknesses": [
      "缺少\"XXX\"这个关键知识点，没答到会丢1分",
      "\"XXX\"这个要点答得不准确，参考答案要求写\"XXX\"，必须包含这几个关键词"
    ],
    "suggestions": [
      "记住三个核心关键词：XXX、XXX、XXX，考试必写",
      "把升级答案模板背下来，重点记\"XXX\"这句话",
      "这道题的采分点是XXX，答题时一定要写出来"
    ]
  },
  "encouragement": {
    "message": "继续努力，把关键知识点记牢！",
    "tip": "💡 考研答题重在踩点得分，把升级答案模板背熟就能拿高分！"
  }
}

**重要提示：**
1. 必须返回有效的JSON格式
2. 升级答案模板要完整、可直接使用
3. 鼓励要真实，不要言过其实，根据实际表现给予恰当反馈
4. 所有建议要可操作、有针对性
`.trim();
}
