import type { GradingRequest } from '@/types';

export function generateGradingPrompt(request: GradingRequest): string {
  const { questionText, referenceAnswer, studentAnswer, scoringCriteria } = request;

  return `
作为专业的教育评估专家，请对学生答案进行5分制评分并生成学习建议。

⚠️ **第一步：预检查（强制执行，不可跳过）**

在进行详细评分前，必须先判断学生答案是否属于以下类型：

【立即给1分的情况 - 无需进一步分析】：
- 纯数字（如"1111"、"123"、"666"等）
- 无意义字符（如"aaaa"、"测试"、"asdfjkl"等）
- 乱码或特殊符号（如"@#$%"、"？？？"等）
- 完全空白或仅有标点符号
- 明显的应付作答（如"不会"、"不知道"、"随便写写"等）
- 与题目完全无关的内容

如果学生答案属于以上任何一种情况，必须：
1. 立即给出分数：1分
2. scoreLabel：需要加强
3. 在feedback中明确指出这是无效答案
4. 其他字段仍需正常生成（升级答案、鼓励等）

---

**题目：**
${questionText}

**参考答案：**
${referenceAnswer}

${scoringCriteria ? `**评分细则：**\n${scoringCriteria}\n` : ''}
**学生答案：**
${studentAnswer}

---

**第二步：正常评分（仅在通过预检查后执行）**

**评分标准（满分5分）：**
- 5分 优秀：完全正确，论述全面深入，表达清晰流畅
- 4分 良好：基本正确，有一定深度，表达较好
- 3分 中等：部分正确，论述一般，有明显不足
- 2分 及格：有对的内容，但问题较多
- 1分 需要加强：大部分错误或严重偏题

**评分要求（严格遵守）：**
1. **仔细对比学生答案与参考答案**，检查知识点覆盖度、准确性、完整性
2. **答非所问或完全错误**的答案必须给1-2分
3. **仅包含少量正确内容**的答案给2-3分
4. **基本正确但不够完整**的答案给3-4分
5. **完全正确且表述优秀**的答案才给5分

---

**任务要求：**

1. **5分制评分**：给出1-5分的评分和对应等级

2. **生成升级答案模板**：
   - 目标分数：当前分数 + 1分
   - 提供一个完整的、可以直接背诵的答案模板
   - 标注关键得分点（3-5个）
   - 建议背诵时间

3. **详细反馈**：
   - 不足：需要改进的地方（至少2个）
     * 必须引用学生答案的具体内容或指出缺失的内容
     * 对比参考答案，说明差距在哪里
     * 语气温和，用建设性的语言描述
     * 具体指出错误或不足之处
   - 建议：具体可操作的改进建议（至少3个）
     * 基于上述不足，给出针对性的改进方法

4. **加油鼓励**：
   - 一句话鼓励（根据实际得分情况给予真实反馈，15字内）
   - 学习小贴士（告诉学生如何提高，包含emoji）

---

**返回JSON格式（严格遵守）：**
{
  "score": 3,
  "scoreLabel": "中等",
  "upgradeAnswer": {
    "targetScore": 4,
    "templateAnswer": "完整的可背诵答案模板，结构清晰，包含所有得分点。第一段总起...",
    "keyPoints": [
      "要点1：具体内容",
      "要点2：具体内容",
      "要点3：具体内容"
    ],
    "memorizeTime": "建议15分钟背诵，分3个部分记忆"
  },
  "feedback": {
    "strengths": [
      "你提到\"XXX\"这个观点很准确，把握住了核心要点",
      "在XXX方面的论述比较清晰"
    ],
    "weaknesses": [
      "你写的\"XXX\"这部分不够准确，参考答案强调的是XXX，两者的差距在于...",
      "你的答案缺少了XXX这个关键知识点，而参考答案中明确提到了..."
    ],
    "suggestions": [
      "建议重点补充XXX知识点，这是得分的关键",
      "可以参考答案模板中的XXX表述方式",
      "注意XXX和XXX的区别"
    ]
  },
  "encouragement": {
    "message": "继续加油，掌握要点后能进步！",
    "tip": "💡 把升级答案模板背下来，下次遇到类似题目可以直接用！"
  }
}

**重要提示：**
1. 必须返回有效的JSON格式
2. 升级答案模板要完整、可直接使用
3. 鼓励要真实，不要言过其实，根据实际表现给予恰当反馈
4. 所有建议要可操作、有针对性
`.trim();
}
